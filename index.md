![Alt text](images/logo_hc_ta.png?raw=true "Title")
## SAP HANA GRAPH

A Graph is based on Nodes and Edges. In our dataset, a Node will represent a Customer or a Merchant and an Edge will present a Transaction which happens between a customer and a Merchant. By visualizing the Transaction network graph , we can see the clusters between merchants & customers, observer anomalies , check the patterns of a Fraudulent Transaction etc.

### Create EDGE TABLE 
Transaction table with Generated merchant names to depict on the graph, We are using JULY TRANSACTION records.
Note please ammend your Group number after CARD_TRAN table below : 


```markdown

create table CARD_TRAN as (
select top 100 *,'TGT' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='7010'
union
select top 100 *,'WAL' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='7011'
union
select top 100 *,'APL' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='6927'
union
select top 100 *,'MAC' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='6059'
union
select top 100 *,'UNI' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='7238'
union
select top 100 *,'MOB' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='5655'
union
select top 100 *,'PEP' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='5877'
union
select top 100 *,'COK' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='5209'
union
select top 100 *,'AZ' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='6604'
union
select top 100 *,'VN' as MER_NAME from "BIUSER"."CARD_TRANSACTIONS_JULY_2020" where CT_MER_ID='7897');
```


### Create a Join of the Transactions data with the Merchant & customer master data:
Ignore below command if the table already exists!
```markdown

create table CARD_TRAN_FULL as (select * from CARD_TRAN a left outer join SOURCEDATA.MERCHANT_CA b on a.CT_MER_ID=b.MER_ID left outer join SOURCEDATA.CUSTOMER c on c.CUST_ID=a.CT_CUST_ID);
```

### Add constraints 
Add constraints on the generated CARD_TRAN table as this is a requirement imposed by the SAP HAAN Graph model

```markdown

alter table CARD_TRAN alter ("CT_CUST_ID" nvarchar(10) NOT NULL );
alter table CARD_TRAN alter ("CT_MER_ID" integer NOT NULL);
alter table CARD_TRAN alter ("MER_NAME" nvarchar(10) NOT NULL);
alter table CARD_TRAN alter ("CT_ID" integer NOT NULL PRIMARY KEY);
alter table CARD_TRAN add ("ID" integer NOT NULL UNIQUE GENERATED ALWAYS AS IDENTITY );
```

### Create Vertex/Nodes Table:
```markdown
drop table "BIUSER"."NODES";
drop table "BIUSER"."NODES";

CREATE COLUMN TABLE "BIUSER"."NODES"( "NODE_KEY" NVARCHAR(100), "TYPE" NVARCHAR(100), "NAME" NVARCHAR(100), "SEGMENT" NVARCHAR(10), "CUST_LIFE_SPEND" NVARCHAR(10), "CUST_AVG_SPEND" NVARCHAR(10), "CUST_INCOME" NVARCHAR(10), "STREET" NVARCHAR(100), "POSTCODE" NVARCHAR(100), "COUNTY" NVARCHAR(100), "STATE" NVARCHAR(10), "COUNTRY" NVARCHAR(5), "LAT" NVARCHAR(100), "LON" NVARCHAR(100));
```

### Insert data into the Nodes Table:

```markdown
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select distinct(CT_CUST_ID), 'CUSTOMER' AS TYPE, CUST_NAME AS NAME,CUST_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,'' as STREET,'' as POSTCODE,'' as COUNTY,'CA' as STATE,'US' AS COUNTRY,'' as LAT,'' as LON from CARD_TRAN_FULL;

insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'TGT' as NODE_KEY, 'MERCHANT' AS TYPE, 'TARGET' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='7010';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'WAL' as NODE_KEY, 'MERCHANT' AS TYPE, 'WALMART' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='7011';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'APL' as NODE_KEY, 'MERCHANT' AS TYPE, 'APL' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='6927';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'MAC' as NODE_KEY, 'MERCHANT' AS TYPE, 'MAC' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='6059';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'UNI' as NODE_KEY, 'MERCHANT' AS TYPE, 'UNI' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='7238';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'MOB' as NODE_KEY, 'MERCHANT' AS TYPE, 'MOB' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='5655';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'PEP' as NODE_KEY, 'MERCHANT' AS TYPE, 'PEP' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='5877';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'AZ' as NODE_KEY, 'MERCHANT' AS TYPE, 'AZ' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='5209';
insert into NODES (NODE_KEY,TYPE,NAME,SEGMENT,CUST_LIFE_SPEND,CUST_AVG_SPEND,CUST_INCOME,STREET,POSTCODE,COUNTY,STATE,COUNTRY,LAT,LON) select 'VN' as NODE_KEY, 'MERCHANT' AS TYPE, 'VN' AS NAME,MER_SEGMENT as SEGMENT,'' as CUST_LIFE_SPEND,'' as CUST_AVG_SPEND,'' as CUST_INCOME,STREET,POSTCODE,COUNTY,'CA' as STATE,'US' AS COUNTRY,LAT,LON from SOURCEDATA.MERCHANT_CA where MER_ID='7897';
```
### ADD constraint on the NODES table
```markdown
alter table NODES alter ("NODE_KEY" nvarchar(100) NOT NULL PRIMARY KEY );
```

### CREATE GRAPH
```markdown
CREATE GRAPH WORKSPACE CT_NETWORK_GRAPH2
EDGE TABLE CARD_TRAN
SOURCE COLUMN CT_CUST_ID
TARGET COLUMN MER_NAME
KEY COLUMN CT_ID
VERTEX TABLE NODES
KEY COLUMN NODE_KEY;

```
